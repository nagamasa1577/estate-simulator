<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸å‹•ç”£æŠ•è³‡ãƒ»ç¯€ç¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* --- ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼è¨­å®š (Dark Navy Style) --- */
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); /* æ¿ƒç´ºã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
            --glass-bg: rgba(255, 255, 255, 0.95); /* ã™ã‚Šã‚¬ãƒ©ã‚¹é¢¨ãƒ‘ãƒãƒ« */
            --glass-border: rgba(255, 255, 255, 0.8);
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            
            --primary: #1e293b; /* æ–‡å­—è‰²ï¼ˆæ¿ƒã„ã‚°ãƒ¬ãƒ¼ï¼‰ */
            --accent: #27ae60;  /* æˆåŠŸãƒ»åˆ©ç›Šã®ç·‘ */
            --danger: #c0392b;  /* èµ¤å­—ãƒ»è­¦å‘Š */
            --warning: #e67e22; /* æ³¨æ„ */
            --amex-blue: #006fcf; /* ã‚¢ãƒ¡ãƒƒã‚¯ã‚¹ãƒ–ãƒ«ãƒ¼ */
            
            --hero-bg: #e8f5e9; /* è–„ã„ç·‘ï¼ˆã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã‚¨ãƒªã‚¢èƒŒæ™¯ï¼‰ */
            --hero-text: #2e7d32; /* æ¿ƒã„ç·‘ï¼ˆã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã‚¨ãƒªã‚¢æ–‡å­—ï¼‰ */
        }

        body {
            font-family: "Noto Sans JP", "Helvetica Neue", Arial, sans-serif;
            background: var(--bg-gradient);
            color: var(--primary);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            line-height: 1.6;
        }

        /* --- 3ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
        .layout-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        /* å·¦ã‚«ãƒ©ãƒ  (ã‚µã‚¤ãƒ‰ãƒãƒ¼) */
        .col-left {
            width: 320px;
            flex-shrink: 0;
            display: flex;
            flex-col;
            gap: 20px;
        }

        /* ä¸­å¤®ã‚«ãƒ©ãƒ  (ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„) */
        .col-center {
            flex: 1; /* æ®‹ã‚Šã®å¹…ã‚’ã™ã¹ã¦ä½¿ã† */
            min-width: 0; /* ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ã‚¢ã‚¤ãƒ†ãƒ ã®ç¸®å°ã‚’è¨±å¯ */
        }

        /* å³ã‚«ãƒ©ãƒ  (ç¾åœ¨ã¯ç©º) */
        .col-right {
            width: 0; /* å°†æ¥ç”¨ */
            display: none; /* ç¾çŠ¶ã¯éè¡¨ç¤º */
        }

        /* --- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ (ã‚¹ãƒãƒ›ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ) --- */
        @media (max-width: 1024px) {
            .layout-wrapper {
                flex-direction: column; /* ç¸¦ä¸¦ã³ã«å¤‰æ›´ */
            }
            .col-left {
                width: 100%; /* æ¨ªå¹…ã„ã£ã±ã„ã« */
                order: 2; /* ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ä¸‹ã«ç§»å‹• */
            }
            .col-center {
                width: 100%;
                order: 1; /* ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä¸Šã« */
            }
        }

        /* --- å…±é€šãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ãƒ¼ãƒ„ --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
        }

        h1 {
            text-align: center;
            color: #fff; /* èƒŒæ™¯ãŒæ¿ƒç´ºãªã®ã§ç™½æ–‡å­— */
            font-size: 24px;
            margin-bottom: 30px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* --- å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼å°‚ç”¨ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
        .promo-card {
            background: linear-gradient(to bottom right, #ffffff, #f0f8ff);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 2px solid #e0e0e0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .promo-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        .promo-text {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 15px;
            text-align: left;
        }
        .btn-amex {
            display: block;
            width: 100%;
            background-color: var(--amex-blue);
            color: white;
            font-weight: bold;
            text-decoration: none;
            padding: 12px 0;
            border-radius: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .btn-amex:hover {
            background-color: #005bb5;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .link-policy {
            font-size: 0.85em;
            color: #ddd; /* æ¿ƒç´ºèƒŒæ™¯ã®ä¸Šãªã®ã§è–„ã„ã‚°ãƒ¬ãƒ¼ */
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
        }
        .copy-btn {
            background: #fff;
            color: #333;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            margin-top: 5px;
        }

        /* --- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼æœ¬ä½“ã®ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
        /* æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ */
        .simulator-wrapper {
            display: flex;
            gap: 20px;
        }
        .sim-col {
            flex: 1;
            transition: all 0.3s;
        }
        #sim-compare {
            display: none;
            border-left: 4px solid var(--accent);
        }
        .show-compare #sim-compare {
            display: block;
        }

        /* ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚¨ãƒªã‚¢ (ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ) */
        .hero-section {
            background-color: var(--hero-bg);
            border: 2px solid var(--accent);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .hero-title { font-size: 1.1em; color: #555; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .hero-val { font-size: 2.8em; font-weight: bold; color: var(--hero-text); margin: 10px 0 5px 0; letter-spacing: -1px; }
        .hero-val.minus { color: var(--danger); }
        .hero-note { font-size: 0.8em; color: #777; }

        /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ */
        .accordion { cursor: pointer; padding: 12px 15px; width: 100%; border: none; text-align: left; outline: none; font-size: 16px; background-color: #eee; color: #444; font-weight: bold; margin-top: 10px; border-radius: 4px; display: flex; justify-content: space-between; box-sizing: border-box; }
        .active, .accordion:hover { background-color: #ddd; }
        .accordion:after { content: '\002B'; font-weight: bold; float: right; margin-left: 5px; }
        .accordion.active:after { content: "\2212"; }
        .panel { padding: 0 15px; background-color: white; max-height: none; overflow: hidden; transition: max-height 0.3s ease-out; border: 1px solid #eee; border-top: none; display: block; box-sizing: border-box; }
        
        /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-size: 14px; color: #666; font-weight: bold; }
        input[type="number"], input[type="text"], select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .note { font-size: 12px; color: #888; margin-top: 4px; display: block; }
        .auto-calc { background-color: #f0f8ff; color: #333; pointer-events: none; border: 1px solid #bce; font-weight: bold; }
        
        .form-group.inline-check { display: flex; align-items: center; gap: 10px; }
        .form-group.inline-check label { margin-bottom: 0; cursor: pointer; }
        .form-group.inline-check input { width: auto; transform: scale(1.2); cursor: pointer; }

        /* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .result-box { background: #fff; padding: 0; margin-top: 20px; }
        .result-section { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px dashed #ddd; }
        .result-section:last-child { border-bottom: none; }
        .result-title { font-size: 1.1em; font-weight: bold; color: var(--primary); margin-bottom: 10px; border-left: 4px solid var(--primary); padding-left: 10px; }
        
        .row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; font-size: 0.95em; }
        .val-pos { color: blue; font-weight: bold; }
        .val-neg { color: var(--danger); font-weight: bold; }
        .val-warn { color: var(--warning); font-weight: bold; }
        
        /* è©³ç´°ãƒœã‚¿ãƒ³ã¨å±•é–‹ã‚¨ãƒªã‚¢ */
        .btn-detail { background: none; border: none; color: #666; font-size: 0.8em; text-decoration: underline; cursor: pointer; margin-left: 5px; padding: 0; }
        .btn-detail:hover { color: var(--primary); }
        .detail-content { display: none; background: #f8f9fa; padding: 10px; margin-top: 5px; border-radius: 5px; border-left: 3px solid #ccc; font-size: 0.85em; color: #555; line-height: 1.5; }
        .detail-content.show { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .formula-line { display: flex; justify-content: space-between; margin-bottom: 3px; }
        .formula-result { border-top: 1px solid #999; margin-top: 3px; padding-top: 3px; text-align: right; font-weight: bold; }

        /* æ“ä½œãƒœã‚¿ãƒ³ */
        .btn-area { text-align: center; margin-bottom: 20px; }
        button.btn { padding: 10px 20px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; color: white; transition: 0.3s; margin: 0 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-save { background-color: var(--primary); }
        .btn-compare { background-color: var(--accent); }
        .btn-copy { background-color: #f39c12; margin-bottom: 15px; width: 100%; font-weight: bold; }
        
        /* ä¸‹éƒ¨ãƒˆãƒ¼ã‚¿ãƒ«æç›Šï¼ˆè©³ç´°ãƒ»å¸¸æ™‚å…¨é–‹ç‰ˆï¼‰ */
        .total-profit-footer { 
            background: #e8f5e9;
            padding: 20px; 
            border-radius: 8px; 
            text-align: center; 
            margin-top: 20px; 
            border: 2px solid var(--accent);
        }
        .total-val-footer { font-size: 1.8em; font-weight: bold; color: var(--accent); margin-bottom: 10px; }
        .total-val-footer.minus { color: var(--danger); }
        
        .breakdown-list {
            text-align: left;
            background: rgba(255,255,255,0.6);
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            font-size: 0.95em;
        }
        .breakdown-row {
            display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px dashed #ccc; padding-bottom: 5px;
        }
        .breakdown-row:last-child { border-bottom: none; }
        .breakdown-total {
            text-align: right; font-weight: bold; margin-top: 10px; border-top: 2px solid #333; padding-top: 5px;
        }
    </style>
</head>
<body>

    <h1>ä¸å‹•ç”£æŠ•è³‡ãƒ»ç¯€ç¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h1>

    <div class="layout-wrapper">
        
        <aside class="col-left">
            <div class="promo-card">
                <div style="font-size:30px; margin-bottom:10px;">ğŸ’³âœˆï¸</div>
                <div class="promo-title">ä¸å‹•ç”£æŠ•è³‡ã¯<br>ã‚«ãƒ¼ãƒ‰å…¥ä¼šç‰¹å…¸<br>ã‚²ãƒƒãƒˆã®ãƒãƒ£ãƒ³ã‚¹</div>
                <div class="promo-text">
                    åˆæœŸè²»ç”¨ã‚„ç¨é‡‘ã®æ”¯æ‰•ã„ã§ä¸€æ°—ã«ãƒã‚¤ãƒ³ãƒˆç²å¾—ã€‚<br>
                    <strong>ã€Œãƒã‚¤ãƒ«ã§è¦–å¯Ÿæ—…è¡Œã€</strong>ã‚‚å¤¢ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>
                    ã©ã®ã‚«ãƒ¼ãƒ‰ãŒä¸€ç•ªãŠå¾—ã‹ãƒã‚§ãƒƒã‚¯ï¼
                </div>
                <a href="https://amex-mile-simulation.com/" target="_blank" class="btn-amex">
                    æç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¸ ï¼
                </a>
            </div>

            <div class="link-policy">
                <div style="font-weight:bold; margin-bottom:5px;">ğŸ”— ãƒªãƒ³ã‚¯ãƒ»å¼•ç”¨ã«ã¤ã„ã¦</div>
                å½“ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã¯ãƒªãƒ³ã‚¯ãƒ•ãƒªãƒ¼ã§ã™ã€‚<br>
                ãƒ–ãƒ­ã‚°ã‚„SNSã§ã”è‡ªç”±ã«ãŠä½¿ã„ãã ã•ã„ã€‚
                <button class="copy-btn" onclick="copyUrl()">URLã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>
        </aside>

        <main class="col-center">
            
            <div class="btn-area">
                <button class="btn btn-save" onclick="saveData()">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
                <button class="btn btn-compare" onclick="toggleCompare()">âš–ï¸ æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
            </div>

            <div class="glass-panel">
                <div class="simulator-wrapper" id="sim-wrapper">
                    
                    <div class="sim-col" id="sim-main">
                        <div id="hero-main" class="hero-section">
                            <div class="hero-title">ğŸ† ãƒˆãƒ¼ã‚¿ãƒ«æœ€çµ‚æç›Š</div>
                            <div class="hero-val" id="hero_total_val">--- å††</div>
                            <div class="hero-note">(ä¿æœ‰ä¸­CF + ç¯€ç¨ç·é¡ + å£²å´ç›Š - è‡ªå·±è³‡é‡‘)</div>
                        </div>

                        <h3 style="text-align:center; margin-top:0; color:#555; font-size:1em;">ãƒ—ãƒ©ãƒ³A (ãƒ¡ã‚¤ãƒ³è¨­å®š)</h3>
                        <div id="form-main"></div>
                        <div id="result-main"></div>
                    </div>

                    <div class="sim-col" id="sim-compare">
                        <div id="hero-cmp" class="hero-section" style="background:#fff3e0; border-color:#f39c12;">
                            <div class="hero-title">ğŸ† ãƒˆãƒ¼ã‚¿ãƒ«æœ€çµ‚æç›Š (B)</div>
                            <div class="hero-val" id="cmp_hero_total_val" style="color:#e67e22;">--- å††</div>
                            <div class="hero-note">(ä¿æœ‰ä¸­CF + ç¯€ç¨ç·é¡ + å£²å´ç›Š - è‡ªå·±è³‡é‡‘)</div>
                        </div>

                        <h3 style="text-align:center; margin-top:0; color:#555; font-size:1em;">ãƒ—ãƒ©ãƒ³B (æ¯”è¼ƒç”¨è¨­å®š)</h3>
                        <button class="btn btn-copy" onclick="copyMainToCompare()">ãƒ—ãƒ©ãƒ³Aã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹</button>
                        <div id="form-compare"></div>
                        <div id="result-compare"></div>
                    </div>

                </div>
            </div>
        </main>

        <aside class="col-right">
            </aside>

    </div>

<script>
    /* =========================================
       ãƒ­ã‚¸ãƒƒã‚¯éƒ¨ï¼ˆå¤‰æ›´ãªã—ï¼‰
       ========================================= */
    const CONSTANTS = {
        residentTaxRate: 0.10, 
        reconstructionTaxRate: 0.021, 
        transferTaxRate: 0.20315, 
        socialInsuranceRate: 0.15 
    };

    const INCOME_TAX_BRACKETS = [
        { limit: 1950000, rate: 0.05, deduction: 0 },
        { limit: 3300000, rate: 0.10, deduction: 97500 },
        { limit: 6950000, rate: 0.20, deduction: 427500 },
        { limit: 9000000, rate: 0.23, deduction: 636000 },
        { limit: 18000000, rate: 0.33, deduction: 1536000 },
        { limit: 40000000, rate: 0.40, deduction: 2796000 },
        { limit: Infinity, rate: 0.45, deduction: 4796000 }
    ];

    const inputsConfig = [
        {
            title: "STEP1: ç‰©ä»¶æƒ…å ±ãƒ»å–å¾—è²»ç”¨",
            fields: [
                { id: "price", label: "ç‰©ä»¶ä¾¡æ ¼ (ä¸‡å††)", type: "number", val: 3000, note: "å£²è²·ä»£é‡‘" },
                { id: "initial_cost_rate", label: "è«¸çµŒè²»ç‡ (%)", type: "number", val: 8, note: "ä»²ä»‹æ‰‹æ•°æ–™ãƒ»ç™»è¨˜ãƒ»ç¨é‡‘ (æ¦‚ç®—7-8%)" },
                { id: "total_cost", label: "ç‰©ä»¶å–å¾—ç·é¡ (ä¸‡å††)", type: "text", val: "", note: "â€»ç‰©ä»¶ä¾¡æ ¼ + è«¸çµŒè²» (è‡ªå‹•è¨ˆç®—)", readonly: true },
                { id: "building_price", label: "ã†ã¡å»ºç‰©ä¾¡æ ¼ (ä¸‡å††)", type: "number", val: 1500, note: "æ¸›ä¾¡å„Ÿå´ã®å¯¾è±¡é¡" },
                { id: "rent", label: "æœˆé¡å®¶è³ƒè¨­å®š (ä¸‡å††)", type: "number", val: 14, note: "æº€å®¤æ™‚æƒ³å®š" },
                { id: "vacancy_rate", label: "æƒ³å®šç©ºå®¤ç‡ (%)", type: "number", val: 15, note: "åœ°æ–¹ç¯‰å¤ãªã‚‰15-20%" },
                { id: "expense_rate", label: "ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°è«¸çµŒè²»ç‡ (%)", type: "number", val: 15, note: "ç®¡ç†è²»ãƒ»ä¿®ç¹•ç©ç«‹ç­‰ (15-20%)" },
                { id: "age", label: "ç¯‰å¹´æ•° (å¹´)", type: "number", val: 45, note: "" },
                { id: "structure", label: "æ§‹é€ ", type: "select", val: "RC", options: ["RC", "é‡é‡é‰„éª¨", "æœ¨é€ "] }
            ]
        },
        {
            title: "STEP2: è³‡é‡‘è¨ˆç”»",
            fields: [
                { id: "required_fund", label: "å¿…è¦è³‡é‡‘ (ä¸‡å††)", type: "text", val: "", note: "â€»STEP1ã®å–å¾—ç·é¡", readonly: true },
                { id: "own_money", label: "è‡ªå·±è³‡é‡‘ (ä¸‡å††)", type: "number", val: 500, note: "é ­é‡‘ + è«¸è²»ç”¨åˆ†" },
                { id: "loan_amount", label: "å€Ÿå…¥é‡‘é¡ (ä¸‡å††)", type: "number", val: 2740, note: "â€»è‡ªå‹•è¨ˆç®— (å¿…è¦è³‡é‡‘ - è‡ªå·±è³‡é‡‘)", readonly: true }, 
                { id: "loan_years", label: "å€Ÿå…¥æœŸé–“ (å¹´)", type: "number", val: 20, note: "" },
                { id: "interest_rate", label: "å€Ÿå…¥é‡‘åˆ© (%)", type: "number", val: 2.3, step: 0.1, note: "å¤‰å‹•/å›ºå®š" }
            ]
        },
        {
            title: "STEP3: ã‚ãªãŸã®å±æ€§ï¼ˆç¯€ç¨è¨ˆç®—ï¼‰",
            fields: [
                { id: "salary", label: "é¡é¢å¹´å (ä¸‡å††)", type: "number", val: 1000, note: "æºæ³‰å¾´åç¥¨ã®æ”¯æ‰•é‡‘é¡" },
                { id: "has_spouse", label: "é…å¶è€…ã‚ã‚Š (æ§é™¤ç”¨)", type: "checkbox_inline", val: false },
                { id: "dependents", label: "æ‰¶é¤Šè¦ªæ—ã®äººæ•° (16æ­³ä»¥ä¸Š)", type: "select", val: "0", options: ["0", "1", "2", "3"], note:"1äººã‚ãŸã‚Š38ä¸‡å††æ§é™¤ã§æ¦‚ç®—" },
                { id: "sell_price", label: "å‡ºå£: ç‰©ä»¶å£²å´æ™‚ æƒ³å®šä¾¡æ ¼ (ä¸‡å††)", type: "number", val: 2400, note: "æ¸›ä¾¡å„Ÿå´æœ€çµ‚å¹´ã®å£²å´é¡" }
            ]
        }
    ];

    function createForm(prefix) {
        let html = "";
        inputsConfig.forEach((section, idx) => {
            html += `<div class="accordion active">${section.title}</div>`;
            html += `<div class="panel" style="max-height: none; display: block;">`;
            section.fields.forEach(field => {
                const fieldId = `${prefix}${field.id}`;
                if (field.type === "checkbox_inline") {
                    html += `<div class="form-group inline-check">`;
                    html += `<label for="${fieldId}">${field.label}</label>`;
                    html += `<input type="checkbox" id="${fieldId}" onchange="calculate('${prefix}')" ${field.val?'checked':''}>`;
                    html += `</div>`;
                } else {
                    html += `<div class="form-group"><label for="${fieldId}">${field.label}</label>`;
                    if (field.type === "select") {
                        html += `<select id="${fieldId}" onchange="calculate('${prefix}')">`;
                        field.options.forEach(opt => {
                            let disp = opt;
                            if (field.id === "dependents") {
                                disp = opt === "3" ? "3äººä»¥ä¸Š" : opt + "äºº";
                            }
                            html += `<option value="${opt}" ${opt===field.val?'selected':''}>${disp}</option>`;
                        });
                        html += `</select>`;
                    } else if (field.type === "checkbox") {
                         html += `<input type="checkbox" id="${fieldId}" onchange="calculate('${prefix}')" ${field.val?'checked':''}>`;
                    } else {
                        html += `<input type="${field.type}" id="${fieldId}" value="${field.val}" step="${field.step||1}" 
                                 class="${field.readonly?'auto-calc':''}" ${field.readonly?'readonly':''} oninput="calculate('${prefix}')">`;
                    }
                    if (field.note) html += `<span class="note">${field.note}</span>`;
                    html += `</div>`;
                }
            });
            html += `</div>`;
        });
        return html;
    }

    document.getElementById("form-main").innerHTML = createForm("main_");
    document.getElementById("form-compare").innerHTML = createForm("cmp_");

    document.addEventListener("click", function(e) {
        if (e.target.classList.contains("accordion")) {
            e.target.classList.toggle("active");
            var panel = e.target.nextElementSibling;
            if (panel.style.display === "block" || panel.style.display === "") {
                panel.style.display = "none";
                panel.style.maxHeight = "0";
            } else {
                panel.style.display = "block";
                panel.style.maxHeight = "none";
            }
        }
    });

    function toggleDetails(btn) {
        const content = btn.nextElementSibling;
        content.classList.toggle("show");
        btn.textContent = content.classList.contains("show") ? "[é–‰ã˜ã‚‹]" : "[è©³ç´°/è¨ˆç®—å¼ã‚’è¦‹ã‚‹]";
    }

    /* --- è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ --- */
    function getVal(id) {
        const el = document.getElementById(id);
        if (!el) return 0;
        if(el.type === "checkbox") return el.checked;
        return Number(el.value);
    }
    
    function setVal(id, val) {
        const el = document.getElementById(id);
        if(el) el.value = val;
    }

    function fmt(num) {
        return num.toLocaleString(undefined, { maximumFractionDigits: 0 });
    }

    function calcDepreciationInfo(structure, age) {
        let statutoryLife = 22; // æœ¨é€ 
        if (structure === "RC") statutoryLife = 47;
        else if (structure === "é‡é‡é‰„éª¨") statutoryLife = 34;

        let years;
        let formula = "";
        if (age >= statutoryLife) {
            years = Math.floor(statutoryLife * 0.2);
            formula = `(${statutoryLife} Ã— 0.2) = ${statutoryLife*0.2}`;
        } else {
            years = Math.floor((statutoryLife - age) + (age * 0.2));
            formula = `(${statutoryLife} - ${age}) + (${age} Ã— 0.2)`;
        }
        years = Math.max(years, 2);
        return { years, formula, statutoryLife };
    }

    function calcIncomeTax(taxableIncome) {
        if (taxableIncome <= 0) return { tax: 0, rate: 0, deduction: 0 };
        let bracket = INCOME_TAX_BRACKETS.find(b => taxableIncome <= b.limit);
        if (!bracket) bracket = INCOME_TAX_BRACKETS[INCOME_TAX_BRACKETS.length - 1];
        const baseTax = (taxableIncome * bracket.rate) - bracket.deduction;
        const totalTax = baseTax * (1 + CONSTANTS.reconstructionTaxRate);
        return { tax: Math.floor(totalTax), rate: bracket.rate, deduction: bracket.deduction };
    }

    function calculate(prefix) {
        const price = getVal(prefix + "price");
        const initialCostRate = getVal(prefix + "initial_cost_rate") / 100;
        const initialCostVal = price * initialCostRate;
        const totalCostVal = price + initialCostVal; 
        
        setVal(prefix + "total_cost", totalCostVal.toFixed(1)); 
        setVal(prefix + "required_fund", totalCostVal.toFixed(1)); 

        const ownMoney = getVal(prefix + "own_money");
        let loanAmountCalc = totalCostVal - ownMoney;
        if (loanAmountCalc < 0) loanAmountCalc = 0;
        setVal(prefix + "loan_amount", loanAmountCalc.toFixed(1));

        const loanAmount = loanAmountCalc;
        const priceYen = price * 10000;
        const buildingPriceYen = getVal(prefix + "building_price") * 10000;
        const rentMonthlyYen = getVal(prefix + "rent") * 10000;
        const vacancyRate = getVal(prefix + "vacancy_rate") / 100;
        const expenseRate = getVal(prefix + "expense_rate") / 100;
        const age = getVal(prefix + "age");
        const structure = document.getElementById(prefix + "structure").value;
        const loanAmountYen = loanAmount * 10000;
        const loanYears = getVal(prefix + "loan_years");
        const interestRate = getVal(prefix + "interest_rate") / 100;
        const ownMoneyYen = ownMoney * 10000;
        
        const salaryYen = getVal(prefix + "salary") * 10000;
        const hasSpouse = getVal(prefix + "has_spouse");
        const dependentsNum = Number(document.getElementById(prefix + "dependents").value);
        const sellPriceYen = getVal(prefix + "sell_price") * 10000;

        const monthlyRate = interestRate / 12;
        const numPayments = loanYears * 12;
        let monthlyPayment = 0;
        if (interestRate > 0 && loanAmountYen > 0) {
            monthlyPayment = loanAmountYen * monthlyRate * Math.pow(1 + monthlyRate, numPayments) / (Math.pow(1 + monthlyRate, numPayments) - 1);
        } else if (loanAmountYen > 0) {
            monthlyPayment = loanAmountYen / numPayments;
        }
        const annualPayment = monthlyPayment * 12;
        const annualRent = rentMonthlyYen * 12;
        const annualOperatingExpense = annualRent * (vacancyRate + expenseRate);
        const annualCashOut = annualOperatingExpense + annualPayment;
        const annualCashFlow = annualRent - annualCashOut;
        const surfaceYield = (annualRent / priceYen) * 100;
        const realYield = ((annualRent - annualOperatingExpense) / priceYen) * 100;

        const depInfo = calcDepreciationInfo(structure, age);
        const depreciationAnnual = buildingPriceYen / depInfo.years;
        const initialCostYen = priceYen * initialCostRate;
        const loanInterestAnnual = loanAmountYen * interestRate;

        const accountingIncome = annualRent * (1 - vacancyRate);
        const accountingExpenseNormal = (annualRent * expenseRate) + depreciationAnnual + loanInterestAnnual;
        const accountingProfitNormal = accountingIncome - accountingExpenseNormal;
        const accountingProfitFirst = accountingProfitNormal - initialCostYen; 

        let salaryDeduction = 0;
        if (salaryYen <= 1625000) salaryDeduction = 550000;
        else if (salaryYen <= 1800000) salaryDeduction = salaryYen * 0.4 - 100000;
        else if (salaryYen <= 3600000) salaryDeduction = salaryYen * 0.3 + 80000;
        else if (salaryYen <= 6600000) salaryDeduction = salaryYen * 0.2 + 440000;
        else if (salaryYen <= 8500000) salaryDeduction = salaryYen * 0.1 + 1100000;
        else salaryDeduction = 1950000;
        
        const salaryIncome = salaryYen - salaryDeduction;
        const socialInsurance = salaryYen * CONSTANTS.socialInsuranceRate;
        const basicDeduction = 480000;
        const spouseDeduction = hasSpouse ? 380000 : 0;
        const dependentDeduction = dependentsNum * 380000;
        const totalDeduction = socialInsurance + basicDeduction + spouseDeduction + dependentDeduction;

        const taxableSalary = Math.max(salaryIncome - totalDeduction, 0);
        const taxBase = calcIncomeTax(taxableSalary);
        const residentTaxBase = Math.floor(taxableSalary * CONSTANTS.residentTaxRate);
        const taxableMergedFirst = Math.max(taxableSalary + accountingProfitFirst, 0);
        const taxFirst = calcIncomeTax(taxableMergedFirst);
        const residentTaxFirst = Math.floor(taxableMergedFirst * CONSTANTS.residentTaxRate);
        const taxableMergedNormal = Math.max(taxableSalary + accountingProfitNormal, 0);
        const taxNormal = calcIncomeTax(taxableMergedNormal);
        const residentTaxNormal = Math.floor(taxableMergedNormal * CONSTANTS.residentTaxRate);

        const totalBenefitFirst = (taxBase.tax - taxFirst.tax) + (residentTaxBase - residentTaxFirst);
        const totalBenefitNormal = (taxBase.tax - taxNormal.tax) + (residentTaxBase - residentTaxNormal);

        const principalRepayed = (loanAmountYen / loanYears) * depInfo.years;
        const remainingLoan = Math.max(loanAmountYen - principalRepayed, 0);
        const landPrice = priceYen - buildingPriceYen;
        const capitalGain = sellPriceYen - landPrice; 
        let transferTax = 0;
        if (capitalGain > 0) {
            transferTax = Math.floor(capitalGain * CONSTANTS.transferTaxRate);
        }
        const exitCash = sellPriceYen - remainingLoan - transferTax;

        const totalCF = annualCashFlow * depInfo.years;
        const totalTaxBenefit = totalBenefitFirst + (totalBenefitNormal * (depInfo.years - 1));
        const totalProfit = totalCF + totalTaxBenefit + exitCash - ownMoneyYen;

        // --- Render ---
        const heroValEl = document.getElementById(prefix === "main_" ? "hero_total_val" : "cmp_hero_total_val");
        heroValEl.innerText = (totalProfit >= 0 ? "+" : "") + fmt(totalProfit) + " å††";
        heroValEl.className = "hero-val " + (totalProfit >= 0 ? "" : "minus");

        const resultDiv = document.getElementById(prefix === "main_" ? "result-main" : "result-compare");
        const isRateDownFirst = taxBase.rate > taxFirst.rate;
        const rateDownMsgFirst = isRateDownFirst ? `<span class="val-warn">â˜…ãƒ©ãƒ³ã‚¯ãƒ€ã‚¦ãƒ³é”æˆ! (${(taxBase.rate*100).toFixed(0)}%â†’${(taxFirst.rate*100).toFixed(0)}%)</span>` : "";
        const isRateDownNormal = taxBase.rate > taxNormal.rate;
        const rateDownMsgNormal = isRateDownNormal ? `<span class="val-warn">â˜…ãƒ©ãƒ³ã‚¯ãƒ€ã‚¦ãƒ³é”æˆ! (${(taxBase.rate*100).toFixed(0)}%â†’${(taxNormal.rate*100).toFixed(0)}%)</span>` : "";

        const renderTaxDetail = (baseT, targetT, resBase, resTarget, mergedIncome, isRateDown, msg) => `
            <div class="formula-line"><strong>[æ‰€å¾—ç¨]</strong> ${isRateDown ? msg : ''}</div>
            <div class="formula-line"><span>æœ¬æ¥:</span> <span>(èª²ç¨æ‰€å¾—${fmt(taxableSalary/10000)}ä¸‡ Ã— ${(baseT.rate*100).toFixed(0)}% - æ§é™¤${fmt(baseT.deduction)}) Ã— 1.021 â‰’ ${fmt(baseT.tax)}</span></div>
            <div class="formula-line"><span style="color:red">ï¼</span> <span>å¯¾ç­–å¾Œ:</span> <span>(èª²ç¨æ‰€å¾—${fmt(mergedIncome/10000)}ä¸‡ Ã— ${(targetT.rate*100).toFixed(0)}% - æ§é™¤${fmt(targetT.deduction)}) Ã— 1.021 â‰’ ${fmt(targetT.tax)}</span></div>
            <div class="formula-result">å·®å¼•: ${fmt(baseT.tax - targetT.tax)} å††</div>
            <hr style="margin:5px 0; border-top:1px dashed #ccc;">
            <div class="formula-line"><strong>[ä½æ°‘ç¨]</strong> (ä¸€å¾‹10%)</div>
            <div class="formula-line"><span>æœ¬æ¥ ${fmt(resBase)}</span> <span style="color:red">ï¼</span> <span>å¯¾ç­–å¾Œ ${fmt(resTarget)}</span></div>
            <div class="formula-result">å·®å¼•: ${fmt(resBase - resTarget)} å††</div>
            <div style="text-align:right; margin-top:5px; font-weight:bold; color:blue;">åˆè¨ˆ: ${fmt((baseT.tax - targetT.tax) + (resBase - resTarget))} å††</div>
        `;

        const transferDetail = `
            <div class="formula-line">å£²å´ç›Š = å£²å´é¡${fmt(sellPriceYen)} - (åœŸåœ°${fmt(landPrice)} + å»ºç‰©1å††)</div>
            <div class="formula-line">= ${fmt(capitalGain)} å††</div>
            <div class="formula-line">ç¨é¡ = ${fmt(capitalGain)} Ã— 20.315%</div>
            <div class="formula-result">= ${fmt(transferTax)} å††</div>
        `;

        const exitCashDetail = `
            <div class="formula-line">å£²å´é¡: ${fmt(sellPriceYen)}</div>
            <div class="formula-line"><span style="color:red">ï¼</span> ãƒ­ãƒ¼ãƒ³æ®‹å‚µ: ${fmt(remainingLoan)} (æ¦‚ç®—)</div>
            <div class="formula-line"><span style="color:red">ï¼</span> è­²æ¸¡ç¨: ${fmt(transferTax)}</div>
            <div class="formula-result">= ${fmt(exitCash)} å††</div>
        `;

        const totalDetail = `
            <div class="breakdown-list">
                <div class="breakdown-row"><span>1. ä¿æœ‰ä¸­CFç´¯è¨ˆ:</span> <span class="${totalCF>=0?'val-pos':'val-neg'}">${fmt(totalCF)}</span></div>
                <div class="breakdown-row"><span>2. ç¯€ç¨ãƒ¡ãƒªãƒƒãƒˆç·é¡:</span> <span class="val-pos">+${fmt(totalTaxBenefit)}</span></div>
                <div class="breakdown-row"><span>3. å£²å´æ‰‹æ®‹ã‚Š:</span> <span class="val-pos">+${fmt(exitCash)}</span></div>
                <div class="breakdown-row"><span>4. å½“åˆè‡ªå·±è³‡é‡‘:</span> <span class="val-neg">-${fmt(ownMoneyYen)}</span></div>
                <div class="breakdown-total">åˆè¨ˆ: ${fmt(totalProfit)} å††</div>
            </div>
        `;

        let html = `
            <div class="result-box">
                <div class="result-section">
                    <div class="result-title">ğŸ’° ç‰©ä»¶åæ”¯ãƒ»ãƒ­ãƒ¼ãƒ³</div>
                    <div class="row"><span>æœˆã€…ãƒ­ãƒ¼ãƒ³è¿”æ¸ˆé¡</span> <span>${fmt(monthlyPayment)} å††</span></div>
                    <div class="row"><span>å¹´é–“ãƒ­ãƒ¼ãƒ³è¿”æ¸ˆé¡</span> <span>${fmt(annualPayment)} å††</span></div>
                    <div class="row"><span>å¹´é–“å®¶è³ƒåå…¥</span> <span>${fmt(annualRent)} å††</span></div>
                    <div class="row"><span>å¹´é–“æ”¯å‡º (è¿”æ¸ˆ+è«¸çµŒè²»)</span> <span>${fmt(annualCashOut)} å††</span></div>
                    <div class="row" style="background:#f0f8ff; padding:5px;"><span>å¹´é–“æ‰‹æ®‹ã‚Š(ç¨å¼•å‰)</span> <span class="${annualCashFlow>=0?'val-pos':'val-neg'}">${fmt(annualCashFlow)} å††</span></div>
                    <div class="row"><span>è¡¨é¢ / å®Ÿè³ªåˆ©å›ã‚Š</span> <span>${surfaceYield.toFixed(1)}% / ${realYield.toFixed(1)}%</span></div>
                    <div class="row"><span>æ¸›ä¾¡å„Ÿå´æœŸé–“</span> <span>${depInfo.years}å¹´</span></div>
                    <div class="note">è¨ˆç®—å¼: ${depInfo.formula}</div>
                </div>

                <div class="result-section">
                    <div class="result-title">ğŸ“‰ ç¯€ç¨ãƒ¡ãƒªãƒƒãƒˆ</div>
                    
                    <div class="row">
                        <span>åˆå¹´åº¦ ç¯€ç¨ãƒ¡ãƒªãƒƒãƒˆ</span> 
                        <span>
                            <span class="val-pos">+${fmt(totalBenefitFirst)} å††</span>
                            <button class="btn-detail" onclick="toggleDetails(this)">[è¨ˆç®—å¼ã‚’è¦‹ã‚‹]</button>
                            <div class="detail-content">
                                ${renderTaxDetail(taxBase, taxFirst, residentTaxBase, residentTaxFirst, taxableMergedFirst, isRateDownFirst, rateDownMsgFirst)}
                            </div>
                        </span>
                    </div>

                    <div class="row">
                        <span>2å¹´ç›®ã€œ ç¯€ç¨ãƒ¡ãƒªãƒƒãƒˆ/å¹´</span> 
                        <span>
                            <span class="val-pos">+${fmt(totalBenefitNormal)} å††</span>
                            <button class="btn-detail" onclick="toggleDetails(this)">[è¨ˆç®—å¼ã‚’è¦‹ã‚‹]</button>
                            <div class="detail-content">
                                ${renderTaxDetail(taxBase, taxNormal, residentTaxBase, residentTaxNormal, taxableMergedNormal, isRateDownNormal, rateDownMsgNormal)}
                            </div>
                        </span>
                    </div>
                </div>

                <div class="result-section">
                    <div class="result-title">ğŸšª å‡ºå£æˆ¦ç•¥ (ä¿æœ‰${depInfo.years}å¹´ãƒ»â€»æ¸›ä¾¡å„Ÿå´æœ€çµ‚å¹´ã§ã®å£²å´)</div>
                    <div class="row"><span>ç‰©ä»¶å£²å´æ™‚ æƒ³å®šä¾¡æ ¼</span> <span>${fmt(sellPriceYen)} å††</span></div>
                    <div class="row">
                        <span>å£²å´æ™‚ è­²æ¸¡ç¨(ç´„20%)</span> 
                        <span>
                            <span class="val-neg">â–²${fmt(transferTax)} å††</span>
                            <button class="btn-detail" onclick="toggleDetails(this)">[è¨ˆç®—å¼ã‚’è¦‹ã‚‹]</button>
                            <div class="detail-content">${transferDetail}</div>
                        </span>
                    </div>
                    <div class="row">
                        <span>å£²å´æ™‚ æ‰‹æ®‹ã‚Šç¾é‡‘</span> 
                        <span>
                            <span class="val-pos">${fmt(exitCash)} å††</span>
                            <button class="btn-detail" onclick="toggleDetails(this)">[è¨ˆç®—å¼ã‚’è¦‹ã‚‹]</button>
                            <div class="detail-content">${exitCashDetail}</div>
                        </span>
                    </div>
                </div>

                <div class="total-profit-footer">
                    <div>ğŸ† ãƒˆãƒ¼ã‚¿ãƒ«æœ€çµ‚æç›Š</div>
                    <div class="total-val-footer ${totalProfit>=0?'':'minus'}">${totalProfit>=0?'+':''}${fmt(totalProfit)} å††</div>
                    <div style="font-size:0.8em; color:#555;">(ä¿æœ‰ä¸­CF + ç¯€ç¨ç·é¡ + å£²å´ç›Š - è‡ªå·±è³‡é‡‘)</div>
                    ${totalDetail}
                </div>
            </div>
        `;
        resultDiv.innerHTML = html;
    }

    function toggleCompare() {
        document.getElementById("main-container").classList.toggle("show-compare");
        const wrapper = document.getElementById("sim-wrapper");
        wrapper.classList.toggle("show-compare");
    }

    function copyMainToCompare() {
        inputsConfig.forEach(section => {
            section.fields.forEach(field => {
                const mainEl = document.getElementById("main_" + field.id);
                const cmpEl = document.getElementById("cmp_" + field.id);
                if (!mainEl || !cmpEl) return;
                if(field.type === "checkbox" || field.type === "checkbox_inline") cmpEl.checked = mainEl.checked;
                else cmpEl.value = mainEl.value;
            });
        });
        calculate("cmp_");
    }

    function saveData() {
        const data = {};
        inputsConfig.forEach(section => {
            section.fields.forEach(field => {
                const el = document.getElementById("main_" + field.id);
                if (el) data[field.id] = (field.type === "checkbox" || field.type === "checkbox_inline") ? el.checked : el.value;
            });
        });
        localStorage.setItem("realEstateSimData_Pro_FinalDesign", JSON.stringify(data));
        alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
    }

    function loadData() {
        const saved = localStorage.getItem("realEstateSimData_Pro_FinalDesign");
        if (saved) {
            const data = JSON.parse(saved);
            Object.keys(data).forEach(key => {
                const el = document.getElementById("main_" + key);
                if (el) {
                    if(el.type === "checkbox") el.checked = data[key];
                    else el.value = data[key];
                }
            });
        }
        calculate("main_");
        calculate("cmp_");
    }
    
    function copyUrl() {
        navigator.clipboard.writeText("https://amex-mile-simulation.com"); // å®Ÿéš›ã®URLã«åˆã‚ã›ã¦å¤‰æ›´å¯èƒ½
        alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
    }

    window.onload = loadData;

</script>
</body>
</html>